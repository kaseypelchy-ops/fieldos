<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Zito FieldOS</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#005696">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FieldOS">
<link rel="apple-touch-icon" href="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png">
<link rel="icon" type="image/png" href="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png">

<!-- Preconnect to every external host so DNS + TLS happens in parallel, not serially -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://server.arcgisonline.com">
<link rel="preconnect" href="https://nominatim.openstreetmap.org">
<link rel="preconnect" href="https://services.arcgisonline.com">
<link rel="dns-prefetch" href="https://script.google.com">

<!-- Fonts: display=swap means text shows in fallback font immediately, custom font swaps in when ready -->
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"/>
<!-- App styles â€” bump ?v= whenever you update style.css so browsers fetch fresh -->
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPLASH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash" class="gone">
  <div class="splash-grid"></div>
  <div class="splash-glow"></div>
  <div class="splash-rings">
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
  </div>
  <div class="splash-body">
    <div class="splash-logo">
      <img src="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png" alt="Zito Media">
    </div>
    <div class="splash-line"></div>
    <div class="splash-tag">Field Operations & Sales Intelligence</div>
    <div class="splash-name" id="splash-rep-name"></div>
    <div class="splash-dots">
      <div class="splash-dot"></div>
      <div class="splash-dot"></div>
      <div class="splash-dot"></div>
    </div>
    <div class="splash-prog-wrap">
      <div class="splash-prog-track">
        <div class="splash-prog-fill" id="splash-prog-fill"></div>
      </div>
      <div class="splash-prog-label">Loading sessionâ€¦</div>
    </div>
  </div>
  <div class="splash-ver">ZITO FIELDOS v1.0.3 â€¢ Production â€¢ Build 2026.02.22</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIGN-OUT CONFIRM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="signout-confirm">
  <div class="signout-box">
    <div class="signout-icon">ğŸ‘‹</div>
    <div class="signout-title">End Session?</div>
    <div class="signout-msg">Your availability will be set to Offline and your session will be securely closed.</div>
    <div class="signout-btns">
      <button class="signout-cancel" onclick="closeSignOutConfirm()">Cancel</button>
      <button class="signout-confirm-btn" onclick="confirmSignOut()">End Session</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETUP PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-setup">
  <div class="logo-bar">
    <img src="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png" alt="Zito Media Logo">
  </div>
  <div class="setup-card">
    <h1>Initialize Sales Session</h1>
    <p class="sub">Securely configure your territory, rep credentials, and address dataset before deployment.</p>

    <div class="step">
      <div class="slabel">Step 1 â€” Your Name</div>
      <input class="txt-in" type="text" id="rep-name" placeholder="e.g. John Smith" oninput="validateRepName()" autocomplete="name">
      <div id="rep-name-hint" style="font-size:11px;color:var(--muted);margin-top:6px;font-family:'Space Mono',monospace;display:none;">âš  Please enter your first and last name</div>
      <div id="rep-profile-status" style="font-size:12px;margin-top:8px;min-height:18px;"></div>
    </div>

    <div class="step">
      <div class="slabel">Step 2 â€” Load Addresses <span style="color:var(--danger)">*Required</span></div>
      <p class="shint">Addresses are loaded automatically once you click Load Addresses. Click the button below to fetch them â€” or upload a CSV as a backup.</p>
      <button class="btn-fetch-addr" id="btn-fetch-addr" onclick="fetchAddressesFromSheet()">
        <span id="fetch-addr-icon">ğŸ“‹</span> Load Addresses
      </button>
      <div id="fetch-addr-status" class="dz-status" style="margin-top:8px"></div>

      <div class="dz-or">â€” or upload CSV backup â€”</div>
      <div class="dropzone" id="dz-csv">
        <input type="file" id="csv-file" accept=".csv">
        <div class="dz-icon">ğŸ“‚</div>
        <div class="dz-label">Drop CSV here or <strong>click to browse</strong></div>
        <div id="csv-status" class="dz-status"></div>
      </div>
    </div>

    <div class="step">
      <div class="slabel">Step 3 â€” Territory KMZ Files <span style="color:var(--muted)">(optional)</span></div>
      <p class="shint">Upload one or more KMZ files to draw territory polygons on the map.</p>
      <div class="dropzone" id="dz-kml">
        <input type="file" id="kml-file" accept=".kml,.kmz" multiple>
        <div class="dz-icon">ğŸ—ºï¸</div>
        <div class="dz-label">Drop KMZ files here or <strong>click to browse</strong></div>
        <div class="dz-label" style="font-size:11px;color:var(--muted);margin-top:2px">Multiple files supported</div>
      </div>
      <div id="kml-file-list"></div>
    </div>

    <button class="btn-launch" id="launch-btn" disabled onclick="launchApp()">Launch</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-app">
  <div id="topbar">
    <div class="tb-logo">
      <img src="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png" alt="Logo" style="height:30px;width:auto;">
    </div>
    <div class="tb-sep"></div>
    <div class="tb-stat">Homes Passed: <strong id="st-total">0</strong></div>
    <div class="tb-stat" style="color:#059669">âœ… Scheduled: <strong id="st-sched">0</strong></div>
    <div class="tb-stat">Pending: <strong id="st-pend">0</strong></div>
    <div class="ml-auto" style="display:flex;align-items:center;gap:8px;">
      <button id="btn-drop-pin-top" class="tb-btn" title="Drop a pin / add an address">ğŸ“ Drop Pin</button>
      <div id="tb-status-pill" class="is-offline" onclick="openBadge()" title="View my badge">
        <span class="status-dot"></span>
        <span id="tb-status-label">OFFLINE</span>
      </div>
      <button id="btn-manager" class="tb-btn" onclick="openManagerPanel()">Team</button>
      <button class="tb-btn" onclick="openBadge()">My Badge</button>
      <button class="tb-btn" onclick="openSignOutConfirm()" title="Sign out" style="color:#f87171;border-color:rgba(239,68,68,.3);">Log Out</button>
    </div>
  </div>

  <!-- Sidebar collapse toggle -->
  <button id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle address list">&#8249;</button>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BADGE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="badge-modal" onclick="if(event.target===this)closeBadge()">
    <div class="badge-wrap">
      <div class="badge-card">
        <div class="badge-stripe"></div>
        <div class="badge-logo-bar">
          <img src="https://www.zitomedia.net/wp-content/uploads/2025/03/Untitled-design-6.png" alt="Zito Media">
          <span class="badge-id-num" id="badge-id-num">REP-000</span>
        </div>
        <div class="badge-avatar" id="badge-avatar">?</div>
        <div class="badge-name" id="badge-rep-name">â€”</div>
        <div class="badge-title">Sales Representative</div>
        
        <div class="badge-contact">
          <div class="badge-contact-row">ğŸ“ <a id="badge-phone-link" href="#"><span id="badge-rep-phone">â€”</span></a></div>
          <div class="badge-contact-row">âœ‰ï¸ <a id="badge-email-link" href="#"><span id="badge-rep-email">â€”</span></a></div>
          <div class="badge-contact-row">ğŸŒ <a id="badge-web-link" href="#" target="_blank" rel="noopener"><span id="badge-rep-web">zitomedia.net</span></a></div>
        </div>

        <div class="badge-email-actions">
          <button class="badge-email-btn mega" onclick="emailCustomerOffer('mega')">Email Mega Offer</button>
          <button class="badge-email-btn gig" onclick="emailCustomerOffer('gig')">Email Gig Offer</button>
        </div>

        <div class="badge-divider"></div>
        <div class="badge-stats">
          <div class="badge-stat">
            <div class="badge-stat-val total-c" id="badge-total">0</div>
            <div class="badge-stat-lbl">Total Sales</div>
          </div>
          <div class="badge-stat">
            <div class="badge-stat-val mega-c" id="badge-mega">0</div>
            <div class="badge-stat-lbl">Mega</div>
          </div>
          <div class="badge-stat">
            <div class="badge-stat-val gig-c" id="badge-gig">0</div>
            <div class="badge-stat-lbl">Gig</div>
          </div>
        </div>
        <div class="badge-divider"></div>
        <div class="badge-status-row">
          <div id="badge-toggle" class="badge-status-toggle offline" onclick="toggleRepStatus()">
            <span class="badge-toggle-dot"></span>
            <span id="badge-status-text">OFFLINE</span>
          </div>
        </div>
        <div class="badge-toggle-hint">Tap to toggle your availability status</div>
      </div>
      <button class="badge-close-btn" onclick="closeBadge()">Close</button>
      <button class="badge-signout-btn" onclick="closeBadge();openSignOutConfirm()">â» End Session</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MANAGER DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="manager-modal" onclick="if(event.target===this)closeManagerPanel()">
    <div class="mgr-wrap">

      <!-- Header -->
      <div class="mgr-header">
        <div>
          <div class="mgr-eyebrow">Manager View</div>
          <div class="mgr-title">Field Intelligence</div>
          <div class="mgr-subtitle" id="mgr-last-refresh">â€”</div>
        </div>
        <button class="mgr-refresh-btn" id="mgr-refresh-btn" onclick="refreshManagerPanel()">â†»</button>
      </div>

      <!-- Top KPI pills -->
      <div class="mgr-summary">
        <div class="mgr-pill"><div class="mgr-pill-val online-c" id="mgr-count-online">â€”</div><div class="mgr-pill-lbl">Online</div></div>
        <div class="mgr-pill"><div class="mgr-pill-val offline-c" id="mgr-count-offline">â€”</div><div class="mgr-pill-lbl">Offline</div></div>
        <div class="mgr-pill"><div class="mgr-pill-val sales-c" id="mgr-count-sales">â€”</div><div class="mgr-pill-lbl">Sales Today</div></div>
      </div>

      <!-- Tab nav -->
      <div class="mgr-tabs">
        <button class="mgr-tab active" onclick="switchMgrTab('team',this)">ğŸ‘¥ Team</button>
        <button class="mgr-tab" onclick="switchMgrTab('analytics',this)">ğŸ“Š Analytics</button>
        <button class="mgr-tab" onclick="switchMgrTab('coverage',this)">ğŸ—º Coverage</button>
        <button class="mgr-tab" onclick="switchMgrTab('forecast',this)">ğŸ’° Forecast</button>
        <button class="mgr-tab" onclick="switchMgrTab('territory',this)">ğŸ¯ Territory</button>
        <!-- AI Coach removed -->
      </div>

      <!-- â”€â”€ TAB: TEAM â”€â”€ -->
      <div id="mgr-tab-team" class="mgr-tab-panel active">
        <div class="mgr-perf">
          <div class="mgr-perf-head">Live Performance</div>
          <div class="mgr-perf-grid">
            <div class="mgr-metric">
              <div class="mgr-metric-lbl">Close Rate</div>
              <div class="mgr-metric-val" id="mgr-m-close">â€”</div>
              <div class="mgr-metric-sub" id="mgr-m-close-sub">â€”</div>
            </div>
            <div class="mgr-metric">
              <div class="mgr-metric-lbl">Sales / Hour</div>
              <div class="mgr-metric-val" id="mgr-m-pace">â€”</div>
              <div class="mgr-metric-sub" id="mgr-m-pace-sub">â€”</div>
            </div>
            <div class="mgr-metric">
              <div class="mgr-metric-lbl">Gig Mix</div>
              <div class="mgr-metric-val" id="mgr-m-gigmix">â€”</div>
              <div class="mgr-metric-sub" id="mgr-m-gigmix-sub">â€”</div>
            </div>
            <div class="mgr-metric">
              <div class="mgr-metric-lbl">Sales / Rep</div>
              <div class="mgr-metric-val" id="mgr-m-spr">â€”</div>
              <div class="mgr-metric-sub" id="mgr-m-spr-sub">â€”</div>
            </div>
          </div>
        </div>
        <div class="mgr-list-head">Field Reps</div>
        <div id="mgr-rep-list">
          <div class="mgr-loading"><div class="mgr-spinner"></div>Loading rep dataâ€¦</div>
        </div>
      </div>

      <!-- â”€â”€ TAB: ANALYTICS â”€â”€ -->
      <div id="mgr-tab-analytics" class="mgr-tab-panel">

        <div class="mgr-two-col">
          <div class="ana-card">
            <div class="ana-card-head">ğŸ• Best Hours to Knock</div>
            <div class="ana-card-sub">Close rate by hour of day â€” based on all recorded door knocks</div>
            <div id="ana-tod-chart" class="tod-chart"></div>
            <div class="tod-x-labels" id="ana-tod-labels"></div>
          </div>

          <div class="ana-card">
            <div class="ana-card-head">ğŸ“¶ Status Breakdown</div>
            <div class="ana-card-sub">Disposition of all worked doors this session</div>
            <div id="ana-status-bars" class="status-bars"></div>
          </div>
        </div>

        <div class="mgr-two-col">
          <div class="ana-card">
            <div class="ana-card-head">ğŸ†š Competitor Landscape</div>
            <div class="ana-card-sub">What service do prospects already have?</div>
            <div id="ana-competitor" class="competitor-grid"></div>
          </div>

          <div class="ana-card">
            <div class="ana-card-head">ğŸ‘¤ Rep Leaderboard</div>
            <div class="ana-card-sub">Ranked by close rate â€” minimum 5 doors worked</div>
            <div id="ana-leaderboard" class="leaderboard-list"></div>
          </div>
        </div>

      </div>

      <!-- â”€â”€ TAB: COVERAGE â”€â”€ -->
      <div id="mgr-tab-coverage" class="mgr-tab-panel">

        <div class="mgr-two-col">
          <div class="ana-card">
            <div class="ana-card-head" style="display:flex;align-items:center;justify-content:space-between;">
              <span>Territory Coverage</span>
              <button class="heat-btn" id="btn-heat-map" onclick="toggleHeatMap()">ğŸŒ¡ Coverage Map</button>
            </div>
            <div class="ana-card-sub">% of addresses knocked per territory</div>
            <div id="cov-territory-bars"></div>
          </div>

          <div class="ana-card">
            <div class="ana-card-head">ğŸ“ Coverage Legend</div>
            <div class="cov-legend">
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#8b5cf6"></span>Mega Sale</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#10b981"></span>Gig Sale</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#d97706"></span>Not Home</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#ef4444"></span>Brightspeed</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#818cf8"></span>In Contract</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#dc2626"></span>Not Interested</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#06b6d4"></span>Go Back Later</div>
              <div class="cov-leg-row"><span class="cov-swatch" style="background:#6b7280"></span>Pending / Untouched</div>
            </div>
          </div>
        </div>

      </div>

      <!-- â”€â”€ TAB: FORECAST â”€â”€ -->
      <div id="mgr-tab-forecast" class="mgr-tab-panel">

        <div class="ana-card forecast-hero">
          <div class="ana-card-head">ğŸ“¡ Revenue Projection</div>
          <div class="ana-card-sub">Based on current close rate applied to remaining pending homes</div>
          <div class="forecast-mrr" id="fc-mrr">â€”</div>
          <div class="forecast-mrr-label">Projected Monthly Recurring Revenue</div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">Projection Inputs</div>
          <div class="fc-inputs-grid" id="fc-inputs-grid"></div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">Territory Breakdown</div>
          <div id="fc-territory-table"></div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">Package Revenue Split</div>
          <div class="fc-pkg-split" id="fc-pkg-split"></div>
        </div>

      </div>

      <!-- â”€â”€ TAB: TERRITORY INTEL â”€â”€ -->
      <div id="mgr-tab-territory" class="mgr-tab-panel">

        <div class="ana-card">
          <div class="ana-card-head">ğŸ“¡ Territory Saturation</div>
          <div class="ana-card-sub">How worked-out is each territory? When to rotate reps in.</div>
          <div id="ti-saturation"></div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">ğŸ†š Competitor Breakdown by Territory</div>
          <div class="ana-card-sub">% of homes using Brightspeed, in contract, or open market â€” per territory</div>
          <div id="ti-competitor-table"></div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">ğŸ”„ Follow-Up Queue</div>
          <div class="ana-card-sub">Go Back Later &amp; Not Home doors across all territories â€” sorted by how long they've been waiting</div>
          <div id="ti-stale-list"></div>
        </div>

        <div class="ana-card">
          <div class="ana-card-head">ğŸ“‹ Deploy Recommendations</div>
          <div class="ana-card-sub">Where to focus reps next based on coverage and close rate data</div>
          <div id="ti-recommendations"></div>
        </div>

      </div>

      <!-- AI Coach tab removed -->

      <button class="mgr-close-btn" onclick="closeManagerPanel()">Close</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GPS PERMISSION PROMPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="gps-prompt" class="gps-prompt-overlay">
    <div class="gps-prompt-box">
      <div class="gps-prompt-icon">ğŸ“</div>
      <div class="gps-prompt-title">Enable Location</div>
      <div class="gps-prompt-body">
        FieldOS uses your location to:<br><br>
        <span class="gps-feat">ğŸ§­ <strong>Route Mode</strong> â€” sort addresses nearest-first as you walk</span>
        <span class="gps-feat">ğŸ“¡ <strong>Territory loading</strong> â€” auto-load homes near you</span>
        <span class="gps-feat">ğŸ”„ <strong>Follow-Up Queue</strong> â€” show distance to each callback</span>
      </div>
      <div class="gps-prompt-sub">Your location is never stored or shared. It stays on your device.</div>
      <button class="gps-btn-allow" onclick="requestGPS()">Allow Location Access</button>
      <button class="gps-btn-skip"  onclick="dismissGPSPrompt()">Not Now</button>
    </div>
  </div>

  <!-- GPS status banner (shows briefly after grant/deny) -->
  <div id="gps-banner" class="gps-banner"></div>

  <div id="panel-list">
    <div class="pl-head">
      <div class="pl-title">
        Addresses
        <span class="pl-badge" id="addr-count">0</span>
      </div>
      <div class="pl-mode-btns">
        <button class="pl-mode-btn" id="btn-route-mode" onclick="toggleRouteMode()">
          <span class="pl-mode-icon">ğŸ§­</span>
          <span class="pl-mode-label">Route</span>
        </button>
        <button class="pl-mode-btn" id="btn-stale-mode" onclick="toggleStaleMode()">
          <span class="pl-mode-icon">ğŸ”„</span>
          <span class="pl-mode-label">Follow-Up</span>
          <span class="pl-mode-count" id="stale-badge"></span>
        </button>
      </div>
      <input class="search-in" id="addr-search" placeholder="ğŸ” Search addressesâ€¦" oninput="filterList(this.value)">
    </div>
    <div id="addr-items"></div>
    <div class="pl-footer">
      <button class="btn-add-addr" onclick="openAddAddrModal()">&#43; Add Address</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD ADDRESS MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="add-addr-modal" onclick="if(event.target===this)closeAddAddrModal()">
    <div class="add-addr-box">
      <div class="add-addr-header">
        <div class="add-addr-title">Add New Address</div>
        <button class="add-addr-close" onclick="closeAddAddrModal()">&#10005;</button>
      </div>
      <div class="add-addr-sub">Enter a home not in the current list. It will be added to your session and saved to the Addresses tab in Google Sheets.</div>

      <div class="fg">
        <label class="fl">Street Address <span style="color:var(--danger)">*</span></label>
        <input class="fi" type="text" id="new-addr-street" placeholder="e.g. 123 Oak St" oninput="checkNewAddrReady()">
      </div>
      <div class="fg-row">
        <div>
          <label class="fl">City <span style="color:var(--danger)">*</span></label>
          <input class="fi" type="text" id="new-addr-city" placeholder="e.g. Burnsville" oninput="checkNewAddrReady()">
        </div>
        <div>
          <label class="fl">State</label>
          <input class="fi" type="text" id="new-addr-state" placeholder="e.g. NC" maxlength="2">
        </div>
      </div>
      <div class="fg">
        <label class="fl">ZIP Code</label>
        <input class="fi" type="text" id="new-addr-zip" placeholder="e.g. 28714" maxlength="10">
      </div>

      <div class="add-addr-note">
        &#128203; This address will also be written to the <strong>Addresses</strong> tab of your Google Sheet so it persists for future sessions.
      </div>

      <button class="btn-add-addr-submit" id="btn-new-addr-submit" onclick="submitNewAddress()" disabled>Add Address</button>
      <div id="add-addr-sending">
        <div class="add-addr-spinner"></div> Saving to Google Sheet&hellip;
      </div>
    </div>
  </div>

  <!-- Pin Drop banner â€” visible while pin mode is active -->
  <div id="pin-drop-banner">ğŸ“ Tap a home on the map to add it</div>

  <!-- Drop Pin FAB â€” mobile only, replaces the topbar button which overflows on small screens -->
  <button id="btn-drop-pin-fab" onclick="togglePinDropMode()" title="Drop a pin / add an address">
    ğŸ“ Drop Pin
  </button>

  <div id="map"></div>

  <!-- Weather Overlay Pill -->
  <div id="wx-pill" class="wx-pill" aria-label="Weather controls">
    <button id="wx-radar-toggle" class="wx-chip wx-toggle" type="button" onclick="wxToggleRadar()" aria-pressed="false">
      <span class="wx-label">Radar</span>
      <span class="wx-switch" aria-hidden="true"><span class="wx-knob"></span></span>
    </button>
    <div id="wx-temp" class="wx-chip wx-temp" title="Current temperature">â€”Â°F</div>
  </div>

  <!-- Geocoding progress bar -->
  <div id="geocode-bar" style="display:none;position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
    background:#fff;border:1px solid #d1d5db;border-radius:10px;padding:12px 20px;
    min-width:300px;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:999;
    flex-direction:column;gap:8px;font-family:'Syne',sans-serif;">
    <div id="gc-text" style="font-size:12px;font-weight:600;color:#374151;text-align:center"></div>
    <div style="background:#e5e7eb;border-radius:4px;height:6px;overflow:hidden;">
      <div id="gc-fill" style="height:100%;background:#2563eb;border-radius:4px;transition:width .4s ease;width:0%"></div>
    </div>
  </div>

  <div id="panel-form">
    <div class="pf-head">
      <div class="pf-info">
        <div class="pf-addr" id="pf-addr-line"></div>
        <div class="pf-sub"  id="pf-addr-sub"></div>
      </div>
      <button class="pf-collapse" id="pf-collapse-btn" onclick="toggleFormCollapse()" title="Collapse / expand form">â–¾</button>
      <button class="pf-close" onclick="closeForm()">âœ•</button>
    </div>
    <div class="pf-body">

      <!-- Active customer notice (shown instead of sales form) -->
      <div id="active-notice" style="display:none">
        <div class="active-notice-box">
          <div class="active-notice-icon">âš¡</div>
          <div class="active-notice-title">Active Customer</div>
          <div class="active-notice-msg">This address is an existing active customer and cannot be sold to.</div>
        </div>
      </div>

      <!-- Sales form (hidden for active customers) -->
      <div id="sales-form-body">

      <!-- Previous disposition banner â€” shown when address has been visited before -->
      <div id="prev-disposition" style="display:none">
        <div class="prev-disp-label">Previous Disposition</div>
        <div class="prev-disp-row">
          <span class="prev-disp-status" id="prev-disp-status"></span>
          <span class="prev-disp-clear" onclick="clearPrevDisposition()" title="Clear disposition">âœ• Clear</span>
        </div>
        <div class="prev-disp-note" id="prev-disp-note" style="display:none"></div>
      </div>

      <div class="sec-head">Customer Info</div>
      <div class="fg-row">
        <div><label class="fl">First Name</label><input class="fi" type="text" id="f-first" placeholder="Jane"></div>
        <div><label class="fl">Last Name</label><input class="fi" type="text" id="f-last" placeholder="Smith"></div>
      </div>
      <div class="fg">
        <label class="fl">Phone</label>
        <input class="fi" type="text" id="f-phone" placeholder="(555) 555-5555" oninput="fmtPhone(this)">
      </div>
      <div class="fg">
        <label class="fl">Email</label>
        <input class="fi" type="text" id="f-email" placeholder="jane@example.com">
      </div>
      <div class="fg">
        <label class="fl">Notes</label>
        <input class="fi" type="text" id="f-notes" placeholder="Gate code, best call time, etc.">
      </div>

      <div class="sec-head">Select Package</div>
      <div class="pkg-grid">
        <div class="pkg-card mega-card" id="pkg-mega" onclick="pickPkg('mega')">
          <span class="pkg-check">âœ“</span>
          <div class="pkg-icon">âš¡</div>
          <div class="pkg-name">Mega Speed</div>
          <div class="pkg-speed">500 Mbps</div>
          <div class="pkg-price">$44.95/mo</div>
        </div>
        <div class="pkg-card gig-card" id="pkg-gig" onclick="pickPkg('gig')">
          <span class="pkg-check">âœ“</span>
          <div class="pkg-icon">ğŸš€</div>
          <div class="pkg-name">Gig Speed</div>
          <div class="pkg-speed">1,000 Mbps</div>
          <div class="pkg-price">$54.95/mo</div>
        </div>
      </div>

      <!-- Pricing Breakdown (shown after package selected) -->
      <div id="pricing-box" style="display:none">

        <div class="sec-head">Schedule Install</div>

        <!-- Schedule picker -->
        <div id="sched-wrap">
          <div id="sched-loading" style="display:none" class="sched-msg">
            <div class="sched-spinner"></div><span>Loading scheduleâ€¦</span>
          </div>
          <div id="sched-error" style="display:none" class="sched-err"></div>

          <div id="sched-picker" style="display:none">
            <div class="sched-nav">
              <button class="sched-nav-btn" onclick="schedShiftWeek(-1)">&#8592;</button>
              <span class="sched-week-label" id="sched-week-label"></span>
              <button class="sched-nav-btn" onclick="schedShiftWeek(1)">&#8594;</button>
            </div>
            <div id="sched-day-grid"></div>
          </div>

          <!-- Confirmed slot -->
          <div id="sched-confirmed" style="display:none" class="sched-confirmed">
            <div class="sched-conf-check">âœ…</div>
            <div class="sched-conf-body">
              <div class="sched-conf-label">Install Scheduled</div>
              <div class="sched-conf-date" id="sched-conf-date"></div>
              <div class="sched-conf-time" id="sched-conf-time"></div>
            </div>
            <button class="sched-conf-change" onclick="schedClearSlot()">âœ• Change</button>
          </div>
        </div>

        <!-- Hidden fields used by calcPricing + payload -->
        <input type="hidden" id="f-install-date">
        <input type="hidden" id="f-install-time">

        <div class="sec-head">Pricing Breakdown</div>
        <div class="price-table">
          <div class="price-section-label">Monthly Bill (recurring)</div>
          <div class="price-row"><span>Internet Service</span><span id="pr-internet">â€”</span></div>
           <div class="price-row"><span>Modem Fee</span><span>$10.00</span></div>
          <div class="price-row"><span>eero 6+ WiFi Router</span><span>$5.00</span></div>
          <div class="price-row"><span>Payment Processing Fee</span><span>$1.00</span></div>
          <div class="price-row price-total"><span>Monthly Total</span><span id="pr-monthly">â€”</span></div>

          <div class="price-section-label" style="margin-top:14px">First Month Bill (promo: internet is free)</div>
          <div class="price-row promo-row"><span>Internet Service</span><span class="free-tag">FREE</span></div>
           <div class="price-row"><span>Modem Fee</span><span>$10.00</span></div>
          <div class="price-row"><span>eero 6+ WiFi Router</span><span>$5.00</span></div>
          <div class="price-row"><span>Payment Processing Fee</span><span>$1.00</span></div>
          <div class="price-row price-total"><span>First Month Bill (fees only)</span><span id="pr-firstbill-fees">$16.00</span></div>
           <div class="price-row"><span style="opacity:.85">+ Estimated Proration (below)</span><span style="opacity:.85">â€”</span></div>
           <div class="price-row price-total"><span>Estimated First Bill Total</span><span id="pr-firstbill-total">â€”</span></div>

          <div id="proration-section" style="display:none">
            <div class="price-section-label" style="margin-top:14px">Estimated Proration (install â†’ 1st of next month)</div>
            <div class="price-row"><span id="pr-prorate-label">Internet</span><span id="pr-prorate-internet">â€”</span></div>
            <div class="price-row"><span id="pr-prorate-eero-label">eero 6+</span><span id="pr-prorate-eero">â€”</span></div>
            <div class="price-row"><span>Payment Processing Fee</span><span>$1.00</span></div>
            <div class="price-row price-total"><span>Estimated Proration Total</span><span id="pr-prorate-total">â€”</span></div>
             <div class="price-note" style="margin-top:10px">
               âœ… <strong>No payment is collected at install.</strong> Estimated proration is added to the first bill.
             </div>
          </div>

          <div class="price-note">
            ğŸ“… Bills are generated on the <strong>1st</strong> of each month and due by the <strong>10th</strong>.
            <br>ğŸ’¡ Promo: First month includes <strong>free internet service</strong>, but standard monthly fees still apply (modem $10, eero $5, processing $1).
          </div>
        </div>
      </div>

      <div class="sec-head">Submit Sale</div>
      <button class="btn-mega" id="btn-mega" onclick="submitSale('Mega Speed')" disabled>âš¡ Submit â€” Mega Speed</button>
      <button class="btn-gig"  id="btn-gig"  onclick="submitSale('Gig Speed')"  disabled>ğŸš€ Submit â€” Gig Speed</button>

      <div class="sec-head">No Sale</div>
      <div class="status-grid">
        <button class="stbtn" id="sbt-nh"  onclick="pickStatus('Not Home')">ğŸšª Not Home</button>
        <button class="stbtn" id="sbt-bs"  onclick="pickStatus('Brightspeed')">âš¡ Brightspeed</button>
        <button class="stbtn" id="sbt-ic"  onclick="pickStatus('In Contract')">ğŸ“‹ In Contract</button>
        <button class="stbtn" id="sbt-ni"  onclick="pickStatus('Not Interested')">âŒ Not Interested</button>
        <button class="stbtn" id="sbt-gbl" onclick="pickStatus('Go Back Later')">ğŸ”„ Go Back Later</button>
        <button class="stbtn" id="sbt-vac" onclick="pickStatus('Vacant')">ğŸšï¸ Vacant</button>
        <button class="stbtn" id="sbt-biz" onclick="pickStatus('Business')">ğŸ¢ Business</button>
      </div>
      
      <!-- No Sale Disposition Note (only for Not Home / Not Interested / Go Back Later) -->
      <div class="fg" id="ns-note-wrap" style="display:none;">
        <label class="fl" for="ns-note">Disposition Note</label>
        <textarea class="fi" id="ns-note" rows="3" placeholder="Quick note (optional)"></textarea>
      </div>

<button class="btn-log" onclick="submitStatus()">Log Status (no sale)</button>

      </div><!-- end sales-form-body -->
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Guide Modal -->
<div id="modal" onclick="handleModalClick(event)">
  <div class="modal-box">
    <h2>âš™ Google Sheets Setup Guide</h2>
    <p>Follow these steps to send sale data automatically to a Google Sheet.</p>

    <h3>1 â€” Create a Google Sheet</h3>
    <p>Add these headers in Row 1 exactly as shown:</p>
    <pre>Timestamp | Salesperson | Address | City | State | Zip | First Name | Last Name | Phone | Email | Package | Install Date | Install Time | Notes | Status</pre>

    <h3>2 â€” Open Apps Script</h3>
    <p>Go to <strong>Extensions â†’ Apps Script</strong>, delete existing code, and paste this:</p>
    <pre>function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var d = JSON.parse(e.postData.contents);
  sheet.appendRow([
    new Date(), d.salesperson,
    d.address, d.city, d.state, d.zip,
    d.firstName, d.lastName, d.phone, d.email,
    d.package, d.installDate, d.installTime, d.notes, d.status
  ]);
  return ContentService
    .createTextOutput(JSON.stringify({result:'success'}))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>

    <h3>3 â€” Deploy as Web App</h3>
    <p>Click <strong>Deploy â†’ New deployment â†’ Web app</strong>. Set <em>Execute as</em>: <strong>Me</strong>, <em>Who has access</em>: <strong>Anyone</strong>. Deploy and authorize.</p>

    <h3>4 â€” Address CSV Format</h3>
    <pre>address,city,state,zip
123 Main St,Burnsville,NC,28714
456 Oak Ave,Burnsville,NC,28714</pre>

    <button class="modal-close" onclick="closeModal()">Close</button>
  </div>
</div>
<!-- Third-party libraries -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- App logic â€” bump ?v= whenever you push a new version of app.js -->
<script defer src="app.js"></script>
<!-- Service worker: caches app shell + tiles so the app loads fast on weak signal -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(function(){});
    });
  }
</script>
</body>
</html>
